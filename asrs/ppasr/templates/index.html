<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>chatGBT-行为树生成</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="text/javascript" src="record.js"></script>
    <link href="index.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- 头-->
<div id="header">
    <h1>C</h1>
    <h1>H</h1>
    <h1>A</h1>
    <h1>T</h1>
    <h1>G</h1>
    <h1>B</h1>
    <h1>T</h1>
</div>
<!-- 主题 -->
<div id="content">
    <!--  选择部分，可以选择输入录音文件，也可以点击录音  -->
    <div class="select clearfix">
        <div class="recognize">
            <h1 class="recognize">File Recognition：</h1>
            <a id="upload" onclick="uploadAudioFile()" class="file">Short Audio</a>
            <a id="upload_long" onclick="uploadLongAudioFile()" class="file">Long Audio</a>
        </div>
        <div class="recording">
            <h1>Audio Input：</h1>
            <img id="record_btn" onclick="record()" src="record.png" alt="录音"/>
        </div>
        <img id="logo" src="bts/logo.png" alt="LOGO">
    </div>

    <div class="display">
        <div id="result">
            <h1 class="text">Task Description</h1>
            <textarea id="result_p"></textarea>
            <img id="btn_generate_bt" class="btn_generate_bt" src="bts/btn_bt_generate.png" alt="BT_G">
            <h1 class="text">ChatGBT Reply</h1>
            <textarea id="result_chatgbt" readonly="readonly" placeholder="bot: Say something"></textarea>
        </div>
        <div id="bt_result">
            <h1 class="text">Behavior Tree Result</h1>
            <img id="bt_img" src="bts/bt_display.png"  alt="Real-time Behavior Tree Image">
        </div>
    </div>
</div>

<script>
    let is_recording = false;
    const host = location.origin;
    let recorder;

    let asr_result;
    const textarea = document.getElementById('result_p');
    const behavior_img = document.getElementById("bt_img");
    // 唤醒词
    const wake_list = ["treebot", "treemate", "jayden"]
    let is_wake = false;
    // 任务描述结束词
    const task_end_list = ["over", "execute", "begin", "come on", "end"]
    let is_task_end = false;

    // 每隔一秒执行一次，读取TaskDescription的内容
    setInterval(() => {
        asr_result = document.getElementById("result_p").value;
        // 如果还没有被唤醒词唤醒，则检测该词是否是唤醒词，并设置
        if (!is_wake) {
            for (let i = 0; i < wake_list.length; i++) {
                if (asr_result.includes(wake_list[i])) {
                    is_wake = true;
                    is_task_end = false;
                    document.getElementById("result_chatgbt").append("You     : " + asr_result + "\n");
                    document.getElementById("result_chatgbt").append("TreeMate: I'm here. How can I help you ^_^ ? ? ?" + "\n");
                    document.getElementById("result_p").value = null;
                    return;
                }
            }
        }

        // 如果还没有触发结束词，则一直检测是否结束。
        if (!is_task_end) {
            for (let i = 0; i < task_end_list.length; i++) {
                if (asr_result.includes(task_end_list[i])) {
                    is_wake = false;
                    is_task_end = true;
                    document.getElementById("result_chatgbt").append("you     : " + asr_result + "\n");
                    document.getElementById("result_chatgbt").append("TreeMate: Please name this task. I will be stronger. ^_^" + "\n");
                    document.getElementById("result_p").value = null;
                    return;
                }
            }
        }
    }, 1000);

    // 当按下生成基元按钮时，触发事件
    const btn_generate_bt  = document.getElementById("btn_generate_bt");
    btn_generate_bt.addEventListener("mousedown",function(){
        // 唤醒后的逻辑。可优化，由于不支持流式的识别，触发另一个事件，一旦按下按钮才开始解析基元。
        if (is_wake) {
            document.getElementById("result_chatgbt").append("You: " + asr_result + "\n");
            document.getElementById("result_p").value = null;
            // 调用后台服务生成行为树基元，并将生成的图片加载到页面上
            try {
                // 创建一个XMLHttpRequest对象
                const xhr = new XMLHttpRequest();
                // 定义一个请求的 URL
                const url = "/generate_bt_img";
                // 收到相应时的回调函数
                xhr.onload = function () {
                    // 将相应的二进制数据作为图片的src
                    // 创建一个 Image 对象
                    const img = new Image();
                    // 当图片加载完成后执行的回调函数
                    img.onload = function () {
                        // 设置图片合适的大小
                        set_bt_img_width(img.width);
                    };
                    // 创建一个 Blob 对象，并设置其类型和内容
                    const blob = new Blob([xhr.response], {type: 'image/png'});
                    img.src = URL.createObjectURL(blob);
                    behavior_img.src = img.src;
                };
                // 设置请求的method和url
                xhr.open('Post', url);
                // 设置相应类型为二进制数据
                xhr.responseType = 'blob';
                // 发送请求
                xhr.send(asr_result);
            } catch (error) {
                console.error("There was a problem")
            }
        }
        // 任务结束逻辑
        if (is_task_end) {
            document.getElementById("result_chatgbt").append("You     : " + asr_result + "\n");
            document.getElementById("result_chatgbt").append("TreeMate:  I have successfully learned to " + asr_result + " task. ^_^ " + "\n\n");
            document.getElementById("result_p").value = null;
            // 为任务命名，并且保存最终图片到 primitives的 task_base中
            try {
                // 创建一个XMLHttpRequest对象
                const xhr = new XMLHttpRequest();
                // 定义一个请求的 URL
                const url = "/generate_and_reuse_bt_img";
                // 收到相应时的回调函数
                xhr.onload = function () {
                    // 将相应的二进制数据作为图片的src
                    // 创建一个 Image 对象
                    const img = new Image();
                    // 当图片加载完成后执行的回调函数
                    img.onload = function () {
                        // 设置图片合适的大小
                        set_bt_img_width(img.width);
                    };
                    // 创建一个 Blob 对象，并设置其类型和内容
                    const blob = new Blob([xhr.response], {type: 'image/png'});
                    img.src = URL.createObjectURL(blob);
                    behavior_img.src = img.src;
                };
                // 设置请求的method和url
                xhr.open('Post', url);
                // 设置相应类型为二进制数据
                xhr.responseType = 'blob';
                // 发送请求
                xhr.send(asr_result);
            } catch (error) {
                console.error("There was a problem")
            }
        }
    });

    // 设置图片大小
    function set_bt_img_width(img_width) {
        if (img_width < 300) {  // 这个1200的单位比像素小很多
            // 计算放大后的宽度和高度
            behavior_img.style.width = '40%';
        } else if (img_width < 500) {
            behavior_img.style.width = '60%';
        } else {
            behavior_img.style.width = '95%'
        }
    }


    function record() {
        if (is_recording) {
            is_recording = false;
            stopRecording()
            document.getElementById('record_btn').src = 'record.png'
        } else {
            is_recording = true;
            startRecording()
            document.getElementById('record_btn').src = 'recording.gif'
        }
    }

    // 开始录音
    function startRecording() {
        let url = 'ws://' + location.hostname + ':5001';
        PPASRRecorder.get(function (record) {
            recorder = record;
        }, url, textarea);
    }

    // 停止录音
    function stopRecording() {
        recorder.stop();
    }

    // 上传短语音
    function uploadAudioFile() {
        var input = document.createElement("input");
        input.type = "file";
        input.accept = "audio/*";
        input.click();
        input.onchange = function () {
            var file = input.files[0];
            upload_file(host + "/recognition", file, function (state, e) {
                switch (state) {
                    case 'uploading':
                        var percentComplete = Math.round(e.loaded * 100 / e.total) + '%';
                        console.log(percentComplete);
                        break;
                    case 'ok':
                        console.log(e.target.responseText)
                        textarea.innerText = e.target.responseText
                        break;
                    case 'error':
                        alert("上传失败");
                        break;
                    case 'cancel':
                        alert("上传被取消");
                        break;
                }
            });
        }
    }

    // 上传长语音
    function uploadLongAudioFile() {
        var input = document.createElement("input");
        input.type = "file";
        input.accept = "audio/*";
        input.click();
        input.onchange = function () {
            var file = input.files[0];
            upload_file(host + "/recognition_long_audio", file, function (state, e) {
                switch (state) {
                    case 'uploading':
                        var percentComplete = Math.round(e.loaded * 100 / e.total) + '%';
                        console.log(percentComplete);
                        break;
                    case 'ok':
                        console.log(e.target.responseText)
                        textarea.innerText = e.target.responseText
                        break;
                    case 'error':
                        alert("上传失败");
                        break;
                    case 'cancel':
                        alert("上传被取消");
                        break;
                }
            });
        }
    }

    // 上传音频文件
    upload_file = function (url, file, callback) {
        var fd = new FormData();
        // 上传的文件名和数据
        fd.append("audio", file);
        var xhr = new XMLHttpRequest();
        xhr.timeout = 60000
        if (callback) {
            xhr.upload.addEventListener("progress", function (e) {
                callback('uploading', e);
            }, false);
            xhr.addEventListener("load", function (e) {
                callback('ok', e);
            }, false);
            xhr.addEventListener("error", function (e) {
                callback('error', e);
            }, false);
            xhr.addEventListener("abort", function (e) {
                callback('cancel', e);
            }, false);
        }
        xhr.open("POST", url);
        xhr.send(fd);
    }
</script>

</body>
</html>